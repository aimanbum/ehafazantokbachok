<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input RPHI | SMKATB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #004d00; --bg: #f4f7f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .container { 
            background: white; max-width: 480px; margin: 0 auto; 
            padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            border-top: 5px solid var(--primary);
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header h2 { margin: 0; color: var(--primary); font-size: 20px; }
        .header p { margin: 5px 0 0; font-size: 13px; color: #666; }

        label { font-weight: 700; font-size: 13px; color: #444; margin-top: 15px; display: block; }
        
        select, input { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 15px; box-sizing: border-box; margin-top: 5px; background: #fff;
        }

        /* Butang Utama */
        button { 
            width: 100%; padding: 15px; margin-top: 25px; 
            background: var(--primary); color: white; border: none; 
            border-radius: 8px; font-weight: bold; font-size: 16px; 
            cursor: pointer; transition: 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* Style untuk Resit (Disembunyikan mula-mula) */
        #resit-box { display: none; text-align: left; border: 2px dashed #ccc; padding: 20px; background: #fff; margin-top: 20px; }
        .resit-item { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .resit-label { font-weight: bold; color: #555; }
        .resit-value { font-weight: normal; color: #000; text-align: right; }

        .btn-group { display: flex; gap: 10px; }
        .btn-print { background: #333; }
        .btn-new { background: #004d00; }

        #loader { text-align: center; color: #666; font-size: 12px; margin-top: 10px; display: none; }

        /* IKLAN: CSS KHAS UNTUK PRINT (Supaya cantik bila tekan Ctrl+P) */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; border: none; width: 100%; max-width: 100%; }
            .no-print { display: none !important; } /* Sembunyikan borang */
            #resit-box { display: block !important; border: 2px solid #000; } /* Tunjuk resit */
            button { display: none; } /* Jangan print butang */
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="logo.png" style="height: 50px;" onerror="this.style.display='none'">
        <h2>Input RPHI Harian</h2>
        <p>Sistem Rekod Prestasi Harian</p>
    </div>

    <div id="form-box" class="no-print">
        <label>TARIKH (Hari Ini)</label>
        <input type="date" id="tarikh">

        <label>TINGKATAN</label>
        <select id="tingkatan" onchange="loadGuru()">
            <option value="">-- Pilih Tingkatan --</option>
            <option value="T1">Tingkatan 1</option>
            <option value="T2">Tingkatan 2</option>
            <option value="T3">Tingkatan 3</option>
            <option value="T4">Tingkatan 4</option>
            <option value="T5">Tingkatan 5</option>
        </select>

        <label>GURU HALAQAH</label>
        <select id="guru" onchange="loadPelajar()" disabled>
            <option value="">-- Pilih Tingkatan Dahulu --</option>
        </select>

        <label>NAMA PELAJAR</label>
        <select id="pelajar" disabled>
            <option value="">-- Pilih Guru Dahulu --</option>
        </select>
        <div id="loader">Sedang mencari data...</div>

        <hr style="margin: 25px 0; border: 0; border-top: 1px dashed #ccc;">

        <label>TASMIK (Lajur D)</label>
        <input type="text" id="tasmik" placeholder="Contoh: Juzuk 1 / Surah Al-Mulk">

        <label>MURAJAAH (Lajur E)</label>
        <input type="text" id="murajaah" placeholder="Contoh: MS 10-15">

        <button id="btnSimpan" onclick="hantarData()">SIMPAN DATA</button>
    </div>

    <div id="resit-box">
        <h3 style="text-align:center; margin-top:0;">BUKTI SERAHAN RPHI</h3>
        <p style="text-align:center; font-size:12px; color:#666;">SMKA TOK BACHOK</p>
        <hr>
        <div class="resit-item"><span class="resit-label">Tarikh:</span> <span class="resit-value" id="r-tarikh">-</span></div>
        <div class="resit-item"><span class="resit-label">Guru:</span> <span class="resit-value" id="r-guru">-</span></div>
        <div class="resit-item"><span class="resit-label">Pelajar:</span> <span class="resit-value" id="r-pelajar">-</span></div>
        <hr>
        <div class="resit-item"><span class="resit-label">Tasmik:</span> <span class="resit-value" id="r-tasmik">-</span></div>
        <div class="resit-item"><span class="resit-label">Murajaah:</span> <span class="resit-value" id="r-murajaah">-</span></div>
        <br>
        <p style="text-align:center; font-size:11px; font-style:italic;">Rekod ini telah berjaya disimpan ke dalam pangkalan data sekolah.</p>
    </div>

    <div id="action-buttons" class="btn-group no-print" style="display:none;">
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è CETAK RESIT</button>
        <button class="btn-new" onclick="location.reload()">‚ûï ISI BARU</button>
    </div>

</div>

<script>
    // Link Apps Script Tuan
    const API_URL = "https://script.google.com/macros/s/AKfycbytqafyIRgUyWVKyCoS6FAZNTAKxsHtNQu2HnVoMh0LvnGYiQqdvXp4GGfpRbsJKC4z/exec";

    document.getElementById('tarikh').valueAsDate = new Date();

    async function loadGuru() {
        const tkt = document.getElementById("tingkatan").value;
        const selGuru = document.getElementById("guru");
        const selPelajar = document.getElementById("pelajar");

        if (!tkt) {
            selGuru.innerHTML = '<option value="">-- Pilih Tingkatan Dahulu --</option>';
            selGuru.disabled = true;
            return;
        }

        selGuru.disabled = true;
        selGuru.innerHTML = '<option>Loading...</option>';
        selPelajar.innerHTML = '<option value="">-- Pilih Guru Dahulu --</option>';
        selPelajar.disabled = true;

        try {
            const response = await fetch(API_URL + "?action=getGuru&tingkatan=" + encodeURIComponent(tkt));
            const data = await response.json();
            
            selGuru.innerHTML = '<option value="">-- Sila Pilih Guru --</option>';
            if (data.length === 0) {
                 selGuru.innerHTML = '<option>Tiada guru untuk ' + tkt + '</option>';
            } else {
                data.forEach(g => {
                    let opt = document.createElement("option");
                    opt.value = g; opt.text = g; selGuru.add(opt);
                });
            }
            selGuru.disabled = false;
        } catch (e) {
            selGuru.innerHTML = '<option>Ralat Sambungan</option>';
            alert("Ralat memuatkan senarai guru.");
        }
    }

    async function loadPelajar() {
        const guru = document.getElementById("guru").value;
        const selPelajar = document.getElementById("pelajar");
        const loader = document.getElementById("loader");

        if (!guru) return;
        
        selPelajar.disabled = true;
        loader.style.display = "block";
        selPelajar.innerHTML = '<option>Sedang mencari...</option>';

        try {
            const response = await fetch(API_URL + "?action=getPelajar&guru=" + encodeURIComponent(guru));
            const data = await response.json();
            
            selPelajar.innerHTML = '<option value="">-- Sila Pilih Pelajar --</option>';
            data.forEach(p => {
                let opt = document.createElement("option");
                opt.value = p; opt.text = p; selPelajar.add(opt);
            });
            selPelajar.disabled = false;
        } catch (e) {
            alert("Gagal membuka fail guru.");
            selPelajar.innerHTML = '<option>Ralat</option>';
        } finally {
            loader.style.display = "none";
        }
    }

    async function hantarData() {
        const guru = document.getElementById("guru").value;
        const pelajar = document.getElementById("pelajar").value;
        const tarikh = document.getElementById("tarikh").value;
        const tasmik = document.getElementById("tasmik").value;
        const murajaah = document.getElementById("murajaah").value;
        const btn = document.getElementById("btnSimpan");

        if (!guru || !pelajar || !tarikh) { alert("Sila lengkapkan maklumat."); return; }

        btn.disabled = true;
        btn.innerText = "SEDANG MENYIMPAN...";

        const payload = {
            action: "harian",
            data: {
                guru: guru,
                pelajar: pelajar,
                tarikh: tarikh,
                tasmik: tasmik,
                murajaah: murajaah
            }
        };

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const result = await response.text();
            
            if (result.includes("Berjaya")) {
                // JIKA BERJAYA: SEMBUNYIKAN BORANG, TUNJUK RESIT
                isiResit(tarikh, guru, pelajar, tasmik, murajaah);
                document.getElementById("form-box").style.display = "none";
                document.getElementById("resit-box").style.display = "block";
                document.getElementById("action-buttons").style.display = "flex";
                
                alert("‚úÖ Data Berjaya Disimpan! Sila cetak resit jika perlu.");
            } else {
                alert(result);
                btn.disabled = false;
                btn.innerText = "SIMPAN DATA";
            }
        } catch (e) {
            alert("Ralat sambungan.");
            btn.disabled = false;
            btn.innerText = "SIMPAN DATA";
        }
    }

    function isiResit(tarikh, guru, pelajar, tasmik, murajaah) {
        document.getElementById("r-tarikh").innerText = tarikh;
        document.getElementById("r-guru").innerText = guru;
        document.getElementById("r-pelajar").innerText = pelajar;
        document.getElementById("r-tasmik").innerText = tasmik || "-";
        document.getElementById("r-murajaah").innerText = murajaah || "-";
    }
</script>

</body>
</html>
