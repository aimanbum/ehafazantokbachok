<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPHI | SMKATB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #004d00; --bg: #f4f7f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        
        .container { 
            background: white; max-width: 600px; margin: 0 auto; 
            padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            border-top: 5px solid var(--primary);
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h2 { margin: 0; color: var(--primary); font-size: 18px; }

        .form-group { margin-bottom: 15px; }
        label { font-weight: 700; font-size: 12px; color: #444; display: block; margin-bottom: 5px; }
        
        select, input { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; 
            font-size: 14px; box-sizing: border-box; background: #fff;
        }

        /* Style Senarai Pelajar */
        #senarai-pelajar { margin-top: 20px; }
        .pelajar-card { 
            background: #fff; border: 1px solid #eee; padding: 15px; 
            border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .pelajar-name { font-weight: bold; color: var(--primary); margin-bottom: 10px; font-size: 14px; text-transform: uppercase; }
        
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-row div { flex: 1; }
        .input-row label { font-size: 10px; color: #888; margin-top: 0; }
        .input-row input { padding: 8px; font-size: 13px; }

        .btn-save { 
            width: 100%; padding: 10px; background: var(--primary); color: white; 
            border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 12px;
        }
        .btn-save:disabled { background: #ccc; }
        .btn-save.success { background: #28a745; }

        #loader { text-align: center; color: #666; font-size: 12px; display: none; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
<div class="header">
    <img src="logo.png" style="height: 60px; margin-bottom: 10px;">
    <h2>REKOD PRESTASI HAFAZAN INDIVIDU</h2>
    <p style="font-size: 11px; color: #666; margin: 5px 0 0;">SMKA TOK BACHOK</p>
    </div>

    <div class="form-group">
        <label>TARIKH TASMIK</label>
        <input type="date" id="tarikh">
    </div>

    <div style="display: flex; gap: 10px;">
        <div class="form-group" style="flex: 1;">
            <label>TINGKATAN</label>
            <select id="tingkatan" onchange="loadGuru()">
                <option value="">-- Pilih --</option>
                <option value="T1">T1</option>
                <option value="T2">T2</option>
                <option value="T3">T3</option>
                <option value="T4">T4</option>
                <option value="T5">T5</option>
            </select>
        </div>

        <div class="form-group" style="flex: 2;">
            <label>GURU HALAQAH</label>
            <select id="guru" onchange="fetchPelajar()" disabled>
                <option value="">-- Pilih Tingkatan --</option>
            </select>
        </div>
    </div>

    <div id="loader">Memuatkan senarai anak murid...</div>

    <div id="senarai-pelajar"></div>

</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbytqafyIRgUyWVKyCoS6FAZNTAKxsHtNQu2HnVoMh0LvnGYiQqdvXp4GGfpRbsJKC4z/exec";

    document.getElementById('tarikh').valueAsDate = new Date();

    async function loadGuru() {
        const tkt = document.getElementById("tingkatan").value;
        const selGuru = document.getElementById("guru");
        if (!tkt) return;

        selGuru.disabled = true;
        selGuru.innerHTML = '<option>Loading...</option>';

        try {
            const response = await fetch(API_URL + "?action=getGuru&tingkatan=" + encodeURIComponent(tkt));
            const data = await response.json();
            selGuru.innerHTML = '<option value="">-- Pilih Guru --</option>';
            data.forEach(g => {
                let opt = document.createElement("option");
                opt.value = g; opt.text = g; selGuru.add(opt);
            });
            selGuru.disabled = false;
        } catch (e) { alert("Ralat muat guru"); }
    }

    async function fetchPelajar() {
        const guru = document.getElementById("guru").value;
        const container = document.getElementById("senarai-pelajar");
        const loader = document.getElementById("loader");

        if (!guru) return;
        
        container.innerHTML = "";
        loader.style.display = "block";

        try {
            const response = await fetch(API_URL + "?action=getPelajar&guru=" + encodeURIComponent(guru));
            const data = await response.json();
            
            if (data.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:red;'>Tiada pelajar dijumpai.</p>";
            } else {
                data.forEach((p, index) => {
                    const card = document.createElement("div");
                    card.className = "pelajar-card";
                    card.innerHTML = `
                        <div class="pelajar-name">${index + 1}. ${p}</div>
                        <div class="input-row">
                            <div>
                                <label>TASMIK (D)</label>
                                <input type="text" id="tasmik-${index}" placeholder="Contoh: Al-Mulk">
                            </div>
                            <div>
                                <label>MURAJAAH (E)</label>
                                <input type="text" id="murajaah-${index}" placeholder="Contoh: MS 10">
                            </div>
                        </div>
                        <button class="btn-save" id="btn-${index}" onclick="simpanIndividu('${p}', ${index})">SIMPAN REKOD</button>
                    `;
                    container.appendChild(card);
                });
            }
        } catch (e) {
            alert("Ralat memuatkan senarai pelajar.");
        } finally {
            loader.style.display = "none";
        }
    }

    async function simpanIndividu(namaPelajar, index) {
        const guru = document.getElementById("guru").value;
        const tarikh = document.getElementById("tarikh").value;
        const tasmik = document.getElementById(`tasmik-${index}`).value;
        const murajaah = document.getElementById(`murajaah-${index}`).value;
        const btn = document.getElementById(`btn-${index}`);

        if (!tasmik && !murajaah) {
            alert("Sila isi Tasmik atau Murajaah sebelum simpan.");
            return;
        }

        btn.disabled = true;
        btn.innerText = "MENYIMPAN...";

        const payload = {
            action: "harian",
            data: {
                guru: guru,
                pelajar: namaPelajar,
                tarikh: tarikh,
                tasmik: tasmik,
                murajaah: murajaah
            }
        };

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const result = await response.text();
            
            if (result.includes("Berjaya")) {
                btn.innerText = "âœ… BERJAYA DISIMPAN";
                btn.classList.add("success");
                // Optional: Kunci input selepas simpan
                document.getElementById(`tasmik-${index}`).disabled = true;
                document.getElementById(`murajaah-${index}`).disabled = true;
            } else {
                alert(result);
                btn.disabled = false;
                btn.innerText = "SIMPAN REKOD";
            }
        } catch (e) {
            alert("Ralat sambungan.");
            btn.disabled = false;
            btn.innerText = "SIMPAN REKOD";
        }
    }
</script>

</body>
</html>
