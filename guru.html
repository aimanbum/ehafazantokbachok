// ==========================================
// 1. FUNGSI SIMPAN DATA (POST)
// ==========================================
function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000); 

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var dataInput = JSON.parse(e.postData.contents); 
    var sheet = ss.getSheetByName(dataInput.sheetName);
    
    // Range C hingga L (Kolum 3 hingga 12)
    var range = sheet.getRange(3, 3, sheet.getLastRow() - 2, 10); 
    var values = range.getValues();
    var updates = dataInput.updates; 
    
    var isUpdated = false;

    for (var i = 0; i < values.length; i++) {
      var namaSheet = values[i][0].toString().trim(); 
      for (var j = 0; j < updates.length; j++) {
        if (updates[j].nama === namaSheet) {
          // Update Muka Surat (Kolum G = Index 4)
          if (updates[j].ms !== "") {
            values[i][4] = updates[j].ms; 
            isUpdated = true;
          }
          // Update Skip (Kolum L = Index 9)
          if (updates[j].skip !== "") {
            values[i][9] = updates[j].skip;
            isUpdated = true;
          }
        }
      }
    }

    if (isUpdated) {
      range.setValues(values);
      SpreadsheetApp.flush();
    }
    return ContentService.createTextOutput("Berjaya").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("Ralat: " + err.message).setMimeType(ContentService.MimeType.TEXT);
  } finally {
    lock.releaseLock();
  }
}

// ==========================================
// 2. FUNGSI AMBIL DATA (GET)
// ==========================================
function doGet(e) {
  var sheetName = e.parameter.sheetName;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(sheetName);
  
  var lastRow = sheet.getLastRow();
  if (lastRow < 3) return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
  
  // Ambil data C3 hingga L (Kolum L adalah data Skip)
  var data = sheet.getRange("C3:L" + lastRow).getValues();
  
  var result = data.filter(r => r[0] && r[0] !== "").map(r => ({
    nama: r[0],           // Kolum C
    ms_semasa: r[4] || "", // Kolum G
    skip_semasa: (r[9] !== undefined && r[9] !== "") ? r[9] : "0" // Kolum L
  }));

  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// ==========================================
// 3. MENU TAMBAHAN
// ==========================================
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('Sistem Hafazan')
      .addItem('Kosongkan M/S Selain 604', 'clearMSExcept604')
      .addToUi();
}

function clearMSExcept604() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  var targetValue = 604;
  var columnG = 7; 

  var ui = SpreadsheetApp.getUi();
  var response = ui.alert('Pengesahan', 'Adakah anda pasti ingin MENGOSONGKAN nilai di Lajur G yang bukan 604?', ui.ButtonSet.YES_NO);

  if (response == ui.Button.YES) {
    sheets.forEach(function(sheet) {
      var excludedSheets = ["juzuk", "REKOD", "UTAMA"]; 
      if (excludedSheets.indexOf(sheet.getName()) > -1) return;
      var lastRow = sheet.getLastRow();
      if (lastRow < 3) return;
      var rangeG = sheet.getRange(3, columnG, lastRow - 2, 1);
      var valuesG = rangeG.getValues();
      var changed = false;
      for (var i = 0; i < valuesG.length; i++) {
        var val = valuesG[i][0];
        if (val !== "" && val != targetValue) {
          valuesG[i][0] = ""; 
          changed = true;
        }
      }
      if (changed) { rangeG.setValues(valuesG); }
    });
    ui.alert('Selesai!');
  }
}
